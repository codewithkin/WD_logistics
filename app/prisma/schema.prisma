// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// =============================================================================
// BETTER-AUTH TABLES (generated by better-auth)
// =============================================================================

model User {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  emailVerified Boolean   @default(false)
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  sessions      Session[]
  accounts      Account[]
  members       Member[]
  invitations   Invitation[]
  editRequestsCreated EditRequest[] @relation("RequestedBy")
  editRequestsApproved EditRequest[] @relation("ApprovedBy")

  @@map("user")
}

model Session {
  id        String   @id @default(cuid())
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  activeOrganizationId String?

  @@map("session")
}

model Account {
  id                    String    @id @default(cuid())
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("verification")
}

// =============================================================================
// BETTER-AUTH ORGANIZATION PLUGIN TABLES
// =============================================================================

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  logo      String?
  createdAt DateTime @default(now())
  metadata  String?

  members           Member[]
  invitations       Invitation[]
  trucks            Truck[]
  drivers           Driver[]
  employees         Employee[]
  customers         Customer[]
  trips             Trip[]
  expenses          Expense[]
  expenseCategories ExpenseCategory[]
  invoices          Invoice[]
  inventoryItems    InventoryItem[]
  reports           Report[]

  @@map("organization")
}

model Member {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role           String   @default("staff") // admin, supervisor, staff
  createdAt      DateTime @default(now())

  @@unique([organizationId, userId])
  @@map("member")
}

model Invitation {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  email          String
  role           String       @default("staff")
  status         String       @default("pending") // pending, accepted, rejected, canceled
  expiresAt      DateTime
  inviterId      String
  inviter        User         @relation(fields: [inviterId], references: [id], onDelete: Cascade)

  @@map("invitation")
}

// =============================================================================
// EDIT REQUEST SYSTEM (For Staff Edits requiring approval)
// =============================================================================

model EditRequest {
  id              String   @id @default(cuid())
  entityType      String   // e.g., "truck", "driver", "expense"
  entityId        String
  originalData    Json
  proposedData    Json
  reason          String
  status          String   @default("pending") // pending, approved, rejected
  requestedById   String
  requestedBy     User     @relation("RequestedBy", fields: [requestedById], references: [id])
  approvedById    String?
  approvedBy      User?    @relation("ApprovedBy", fields: [approvedById], references: [id])
  approvedAt      DateTime?
  rejectionReason String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("edit_request")
}

// =============================================================================
// TRUCK MANAGEMENT
// =============================================================================

model Truck {
  id              String   @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  registrationNo  String
  make            String
  model           String
  year            Int
  chassisNumber   String?
  engineNumber    String?
  status          String   @default("active") // active, in_service, in_repair, inactive, decommissioned
  currentMileage  Int      @default(0)
  fuelType        String?
  tankCapacity    Float?
  image           String?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  trips           Trip[]
  truckExpenses   TruckExpense[]
  partAllocations PartAllocation[]
  assignedDriver  Driver?  @relation("AssignedTruck")

  @@unique([organizationId, registrationNo])
  @@index([organizationId, status])
  @@map("truck")
}

model TruckExpense {
  id        String   @id @default(cuid())
  truckId   String
  truck     Truck    @relation(fields: [truckId], references: [id], onDelete: Cascade)
  expenseId String
  expense   Expense  @relation(fields: [expenseId], references: [id], onDelete: Cascade)

  @@unique([truckId, expenseId])
  @@map("truck_expense")
}

// =============================================================================
// DRIVER MANAGEMENT
// =============================================================================

model Driver {
  id              String    @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  firstName       String
  lastName        String
  email           String?
  phone           String
  whatsappNumber  String?
  passportNumber  String?
  licenseNumber   String
  licenseExpiry   DateTime?
  dateOfBirth     DateTime?
  address         String?
  image           String?
  startDate       DateTime  @default(now())
  endDate         DateTime?
  status          String    @default("active") // active, on_leave, suspended, terminated
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  assignedTruckId String?   @unique
  assignedTruck   Truck?    @relation("AssignedTruck", fields: [assignedTruckId], references: [id])
  trips           Trip[]

  @@map("driver")
}

// =============================================================================
// EMPLOYEE MANAGEMENT
// =============================================================================

model Employee {
  id               String    @id @default(cuid())
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  firstName        String
  lastName         String
  email            String?
  phone            String
  position         String
  department       String?
  image            String?
  idNumber         String?
  address          String?
  emergencyContact String?
  startDate        DateTime  @default(now())
  endDate          DateTime?
  dismissalReason  String?
  status           String    @default("active") // active, on_leave, suspended, terminated
  salary           Float?
  notes            String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  partAllocations  PartAllocation[]

  @@map("employee")
}

// =============================================================================
// CUSTOMER MANAGEMENT
// =============================================================================

model Customer {
  id             String    @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name           String
  contactPerson  String?
  email          String?
  phone          String?
  address        String?
  taxId          String?
  paymentTerms   Int       @default(30)
  creditLimit    Float?
  balance        Float     @default(0)
  notes          String?
  status         String    @default("active") // active, inactive, suspended
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  trips          Trip[]
  invoices       Invoice[]
  payments       Payment[]

  @@map("customer")
}

// =============================================================================
// TRIP MANAGEMENT
// =============================================================================

model Trip {
  id                 String    @id @default(cuid())
  organizationId     String
  organization       Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  truckId            String
  truck              Truck     @relation(fields: [truckId], references: [id])
  driverId           String
  driver             Driver    @relation(fields: [driverId], references: [id])
  customerId         String?
  customer           Customer? @relation(fields: [customerId], references: [id])

  // Route Information
  originCity         String
  originAddress      String?
  originLat          Float?
  originLng          Float?
  destinationCity    String
  destinationAddress String?
  destinationLat     Float?
  destinationLng     Float?

  // Load Information
  loadDescription    String?
  loadWeight         Float?
  loadUnits          Int?

  // Mileage Tracking
  estimatedMileage   Int
  actualMileage      Int?
  startOdometer      Int?
  endOdometer        Int?

  // Financial
  revenue            Float     @default(0)

  // Status & Dates
  status             String    @default("scheduled") // scheduled, in_progress, completed, cancelled
  scheduledDate      DateTime
  startDate          DateTime?
  endDate            DateTime?

  // Notifications
  driverNotified     Boolean   @default(false)
  notifiedAt         DateTime?

  notes              String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  tripExpenses       TripExpense[]

  @@index([organizationId, status])
  @@index([organizationId, scheduledDate])
  @@index([driverId, status])
  @@map("trip")
}

model TripExpense {
  id        String   @id @default(cuid())
  tripId    String
  trip      Trip     @relation(fields: [tripId], references: [id], onDelete: Cascade)
  expenseId String
  expense   Expense  @relation(fields: [expenseId], references: [id], onDelete: Cascade)

  @@unique([tripId, expenseId])
  @@map("trip_expense")
}

// =============================================================================
// EXPENSE MANAGEMENT
// =============================================================================

model ExpenseCategory {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name           String
  description    String?
  isTrip         Boolean  @default(false)
  isTruck        Boolean  @default(false)
  color          String?
  icon           String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  expenses       Expense[]

  @@unique([organizationId, name])
  @@map("expense_category")
}

model Expense {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  categoryId     String
  category       ExpenseCategory @relation(fields: [categoryId], references: [id])
  amount         Float
  description    String?
  date           DateTime @default(now())
  receiptUrl     String?
  vendor         String?
  reference      String?
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  truckExpenses  TruckExpense[]
  tripExpenses   TripExpense[]

  @@index([organizationId, date])
  @@index([categoryId])
  @@map("expense")
}

// =============================================================================
// INVOICE & PAYMENT MANAGEMENT
// =============================================================================

model Invoice {
  id              String    @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  customerId      String
  customer        Customer  @relation(fields: [customerId], references: [id])
  invoiceNumber   String

  // Financial
  subtotal        Float
  tax             Float     @default(0)
  total           Float
  amountPaid      Float     @default(0)
  balance         Float

  // Dates
  issueDate       DateTime  @default(now())
  dueDate         DateTime
  maxReminderDate DateTime?

  // Status
  status          String    @default("draft") // draft, sent, paid, partial, overdue, cancelled

  // Reminders
  reminderSent    Boolean   @default(false)
  reminderSentAt  DateTime?

  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  lineItems       InvoiceLineItem[]
  payments        Payment[]

  @@unique([organizationId, invoiceNumber])
  @@index([organizationId, status])
  @@index([customerId, status])
  @@index([dueDate])
  @@map("invoice")
}

model InvoiceLineItem {
  id          String   @id @default(cuid())
  invoiceId   String
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  description String
  quantity    Int      @default(1)
  unitPrice   Float
  total       Float

  @@map("invoice_line_item")
}

model Payment {
  id          String   @id @default(cuid())
  invoiceId   String
  invoice     Invoice  @relation(fields: [invoiceId], references: [id])
  customerId  String
  customer    Customer @relation(fields: [customerId], references: [id])
  amount      Float
  paymentDate DateTime @default(now())
  method      String   // cash, bank_transfer, check, mobile_money, other
  reference   String?
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([customerId])
  @@index([paymentDate])
  @@map("payment")
}

// =============================================================================
// INVENTORY MANAGEMENT
// =============================================================================

model InventoryItem {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name           String
  sku            String?
  category       String?
  quantity       Int      @default(0)
  minQuantity    Int      @default(5)
  unitCost       Float?
  location       String?
  supplier       String?
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  allocations    PartAllocation[]

  @@unique([organizationId, sku])
  @@map("inventory_item")
}

model PartAllocation {
  id              String   @id @default(cuid())
  inventoryItemId String
  inventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id])
  truckId         String
  truck           Truck    @relation(fields: [truckId], references: [id])
  allocatedById   String
  allocatedBy     Employee @relation(fields: [allocatedById], references: [id])
  quantity        Int      @default(1)
  reason          String?
  allocatedAt     DateTime @default(now())

  @@map("part_allocation")
}

// =============================================================================
// REPORT GENERATION
// =============================================================================

model Report {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  type           String   // profit_per_unit, revenue, expenses, overall, tires, customer_statement, trip_summary, truck_performance
  period         String   // daily, weekly, monthly, quarterly, yearly, custom
  startDate      DateTime
  endDate        DateTime
  format         String   // pdf, csv
  fileUrl        String?
  generatedById  String
  createdAt      DateTime @default(now())

  @@map("report")
}

// =============================================================================
// NOTIFICATION LOG
// =============================================================================

model Notification {
  id             String    @id @default(cuid())
  type           String    // trip_assignment, invoice_reminder, payment_received, general
  recipientPhone String
  message        String
  status         String    @default("pending") // pending, sent, failed
  sentAt         DateTime?
  error          String?
  metadata       Json?
  createdAt      DateTime  @default(now())

  @@map("notification")
}
